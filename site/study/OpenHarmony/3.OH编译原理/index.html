
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="If we could meet again in our next life, I would be more mature and marry you.">
      
      
        <meta name="author" content="XiaoLi">
      
      
        <link rel="canonical" href="https://wxnlP.github.io/study/OpenHarmony/3.OH%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/">
      
      
        <link rel="prev" href="../2.OHIDE%E5%BC%80%E5%8F%91/">
      
      
        <link rel="next" href="../../ROS2/1.1-ROS%E4%B8%8EROS2%E4%BB%8B%E7%BB%8D/">
      
      
      <link rel="icon" href="../../../assets/icon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.34">
    
    
      
        <title>第三章 编译原理 - 小李 的知识库</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.35f28582.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="LightDay" data-md-color-primary="white" data-md-color-accent="red">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#31" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="小李 的知识库" class="md-header__button md-logo" aria-label="小李 的知识库" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m19 2-5 4.5v11l5-4.5zM6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            小李 的知识库
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              第三章 编译原理
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="LightDay" data-md-color-primary="white" data-md-color-accent="red"  aria-label="切换至夜间模式"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="切换至夜间模式" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="切换至高亮模式"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="切换至高亮模式" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/wxnlP/wxnlP.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    wxnlP/wxnlP.github.io
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
    
  
  你我有幸相会！

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../0.%E9%98%85%E8%AF%BB%E5%89%8D%E7%9A%84%E5%A3%B0%E6%98%8E/" class="md-tabs__link">
          
  
    
  
  OpenHarmony

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../ROS2/1.1-ROS%E4%B8%8EROS2%E4%BB%8B%E7%BB%8D/" class="md-tabs__link">
          
  
    
  
  ROS2

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../STM32/0.%E9%98%85%E8%AF%BB%E5%A3%B0%E6%98%8E/" class="md-tabs__link">
          
  
    
  
  STM32系列

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../FreeRTOS/0.ARM%E6%9E%B6%E6%9E%84%E7%AE%80%E6%98%8E%E6%95%99%E7%A8%8B/" class="md-tabs__link">
          
  
    
  
  FreeRTOS

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../competition/1/" class="md-tabs__link">
          
  
    
  
  工创赛

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../yolov5/1/" class="md-tabs__link">
          
  
    
  
  YOLO系列

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../Git/Git/" class="md-tabs__link">
        
  
    
  
  Git

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../%E9%A3%9E%E4%B9%A6%E6%96%87%E6%A1%A3/pythondata/" class="md-tabs__link">
          
  
    
  
  资料分析

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="小李 的知识库" class="md-nav__button md-logo" aria-label="小李 的知识库" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m19 2-5 4.5v11l5-4.5zM6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5"/></svg>

    </a>
    小李 的知识库
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/wxnlP/wxnlP.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    wxnlP/wxnlP.github.io
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    你我有幸相会！
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    OpenHarmony
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            OpenHarmony
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../0.%E9%98%85%E8%AF%BB%E5%89%8D%E7%9A%84%E5%A3%B0%E6%98%8E/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    阅读声明
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1.OH%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%BC%80%E5%8F%91/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第一章 命令行开发
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2.OHIDE%E5%BC%80%E5%8F%91/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第二章 IDE开发
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    第三章 编译原理
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    第三章 编译原理
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#31" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 编译构建系统
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.1 编译构建系统">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#311" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.1 编译构建系统简介
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#312" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.2 编译构建系统的配置规则
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.1.2 编译构建系统的配置规则">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1. 源码的命名规则
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2. 源码目录树的构建规则
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      3. 组件的定义
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      4. 组件的编译目标
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      5. 组件的编译脚本
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#313" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.3 子系统构建模型
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#314" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.4 芯片解决方案配置规则
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#315" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.5 产品解决方案配置规则
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#32" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 编译构建系统的使用
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.2 编译构建系统的使用">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#321-1" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.1 案例1：新增组件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#322-2" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.2 案例2：新增产品解决方案
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#323-3" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.3 案例3：组件/模块开发
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.2.3 案例3：组件/模块开发">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-app" class="md-nav__link">
    <span class="md-ellipsis">
      1. APP架构与代码
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_1" class="md-nav__link">
    <span class="md-ellipsis">
      2. 编译脚本
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_1" class="md-nav__link">
    <span class="md-ellipsis">
      3. 编译烧录运行
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#324" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.4 系统启动阶段与宏命令
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#33" class="md-nav__link">
    <span class="md-ellipsis">
      3.3 轻量系统的数据持久化
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.3 轻量系统的数据持久化">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#331" class="md-nav__link">
    <span class="md-ellipsis">
      3.3.1 数据持久化简介
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#332" class="md-nav__link">
    <span class="md-ellipsis">
      3.3.2 键值存储与文件操作简介
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#333" class="md-nav__link">
    <span class="md-ellipsis">
      3.3.3 键值存储案例
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#334" class="md-nav__link">
    <span class="md-ellipsis">
      3.3.4 文件操作案例
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../ROS2/1.1-ROS%E4%B8%8EROS2%E4%BB%8B%E7%BB%8D/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    ROS2
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../STM32/0.%E9%98%85%E8%AF%BB%E5%A3%B0%E6%98%8E/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    STM32系列
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../FreeRTOS/0.ARM%E6%9E%B6%E6%9E%84%E7%AE%80%E6%98%8E%E6%95%99%E7%A8%8B/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    FreeRTOS
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../competition/1/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    工创赛
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../yolov5/1/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    YOLO系列
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Git/Git/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Git
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../%E9%A3%9E%E4%B9%A6%E6%96%87%E6%A1%A3/pythondata/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    资料分析
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#31" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 编译构建系统
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.1 编译构建系统">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#311" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.1 编译构建系统简介
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#312" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.2 编译构建系统的配置规则
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.1.2 编译构建系统的配置规则">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1. 源码的命名规则
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2. 源码目录树的构建规则
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      3. 组件的定义
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      4. 组件的编译目标
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      5. 组件的编译脚本
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#313" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.3 子系统构建模型
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#314" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.4 芯片解决方案配置规则
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#315" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.5 产品解决方案配置规则
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#32" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 编译构建系统的使用
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.2 编译构建系统的使用">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#321-1" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.1 案例1：新增组件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#322-2" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.2 案例2：新增产品解决方案
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#323-3" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.3 案例3：组件/模块开发
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.2.3 案例3：组件/模块开发">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-app" class="md-nav__link">
    <span class="md-ellipsis">
      1. APP架构与代码
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_1" class="md-nav__link">
    <span class="md-ellipsis">
      2. 编译脚本
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_1" class="md-nav__link">
    <span class="md-ellipsis">
      3. 编译烧录运行
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#324" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.4 系统启动阶段与宏命令
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#33" class="md-nav__link">
    <span class="md-ellipsis">
      3.3 轻量系统的数据持久化
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.3 轻量系统的数据持久化">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#331" class="md-nav__link">
    <span class="md-ellipsis">
      3.3.1 数据持久化简介
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#332" class="md-nav__link">
    <span class="md-ellipsis">
      3.3.2 键值存储与文件操作简介
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#333" class="md-nav__link">
    <span class="md-ellipsis">
      3.3.3 键值存储案例
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#334" class="md-nav__link">
    <span class="md-ellipsis">
      3.3.4 文件操作案例
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/wxnlP/wxnlP.github.io/edit/master/docs/study/OpenHarmony/3.OH编译原理.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/wxnlP/wxnlP.github.io/raw/master/docs/study/OpenHarmony/3.OH编译原理.md" title="View source of this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg>
    </a>
  


  <h1>第三章 编译原理</h1>

<h2 id="31">3.1 编译构建系统<a class="headerlink" href="#31" title="Permanent link">&para;</a></h2>
<blockquote>
<p>基于轻量系统</p>
</blockquote>
<h3 id="311">3.1.1 编译构建系统简介<a class="headerlink" href="#311" title="Permanent link">&para;</a></h3>
<ol>
<li>OpenHarmony基于<kbd>gn</kbd>和<kbd>ninja</kbd>，以支持组件化开发为目标。</li>
<li>支持独立构建<kbd>组件</kbd>、<kbd>开发板</kbd>、<kbd>组件拼接的产品</kbd>。</li>
</ol>
<details class="note">
<summary>Note</summary>
<p>关于组件这个名称，我查看官网为部件，都是指component，系统最小功能单元。</p>
</details>
<p>编译构建系统用到的相关基础概念</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>概念</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>子系统</strong></td>
<td>子系统由一个或多个组件构成。</td>
</tr>
<tr>
<td><strong>组件</strong></td>
<td>组件是一个可复用、可配置、可裁剪的系统最小功能单元。</td>
</tr>
<tr>
<td><strong>ninja</strong></td>
<td>ninja是一个专注速度的小型的编译构建系统。</td>
</tr>
<tr>
<td><strong>gn</strong></td>
<td>gn全称为 "generate ninja"，是一个现代化编译构建工具。</td>
</tr>
<tr>
<td><strong>hb</strong></td>
<td>hb是OpenHarmony的命令行工具，用于执行编译命令。</td>
</tr>
</tbody>
</table>
<details class="note">
<summary>Note</summary>
<p>联系一下常见的工具会更好理解，比如当我们使用STM32的Cmake开发方式时，我们的编译构建系统使用的就是Camke和ninja，此时Camke就是与gn一样的作用。</p>
</details>
<p>关于系统、子系统、组件的关系如下图，其中子系统和组件支持 <strong>裁剪</strong> 。</p>
<p><img alt="image-20241229142621148" src="image-20241229142621148.png" /></p>
<p><code>build/lite</code>是轻量级设备（如 IoT 设备）编译构建系统的核心部分，目录主要内容如下：</p>
<div class="language-text highlight"><span class="filename">Text Only</span><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>build/lite            
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>├── components        # 组件描述文件
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>├── config            # 编译配置文件
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>|   ├── component     # 组件相关模板定义
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>|   ├── kernel        # 内核的编译配置参数
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>|   └── subsystem     # 子系统的编译配置模板
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>├── figures           # readme的图片
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>├── hb                # hb的pip安装包源码
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>├── make_rootfs       # 文件系统镜像制作脚本
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>├── ndk               # Native API相关编译脚本与配置参数
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>├── testfwk           # 测试编译框架
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>└── toolchain         # 编译工具链配置
</span></code></pre></div>
<p>在轻量系统中，一个组件不能单独编译，必须加入一个产品或开发板方案。关于前面用到的编译指令：</p>
<ul>
<li><code>hb set</code>，用于选择OpenHarmony的源码目录和要编译的目标保存至相应的配置文件中。</li>
</ul>
<ul>
<li><code>hb build</code>，经历一个较为复杂的过程<ol>
<li>读取编译配置。根据产品选择的开发板，读取开发板的<code>config.gni</code>文件。</li>
<li>调用gn。生成从产品解决方案的<code>out</code>目录和<code>ninja</code>文件。</li>
<li>调用ninja。也就是调用“<code>ninja -C out/board/product</code>”命令启动编译。</li>
<li>系统镜像文件打包。就是将组件编译产物进行打包，设置文件的属性和权限，制作文件系统的镜像文件。</li>
</ol>
</li>
</ul>
<blockquote>
<p>关于系统镜像文件打包简单理解就是生成<code>.bin</code>二进制烧录文件。</p>
</blockquote>
<h3 id="312">3.1.2 编译构建系统的配置规则<a class="headerlink" href="#312" title="Permanent link">&para;</a></h3>
<details class="danger">
<summary>Danger</summary>
<p>这里很重要也很难，若此部分不理解，建议购买书籍阅读。</p>
</details>
<h4 id="1"><strong>1. 源码的命名规则</strong><a class="headerlink" href="#1" title="Permanent link">&para;</a></h4>
<ol>
<li>一个组件一个单独的文件夹。</li>
<li>组件源码分为三层，最外层为<kbd>领域</kbd>，也称为子系统集，内层依次为<kbd>子系统</kbd>和<kbd>组件</kbd></li>
</ol>
<h4 id="2"><strong>2. 源码目录树的构建规则</strong><a class="headerlink" href="#2" title="Permanent link">&para;</a></h4>
<ol>
<li>组件的目录结构应如下：</li>
</ol>
<div class="language-text highlight"><span class="filename">Text Only</span><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>component
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>├── interfaces       # 接口
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>|   ├── innerkits    # 系统内接口，供组件开发者使用
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>|   └── kits         # 应用接口，供应用开发者使用
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>├── frameworks       # framework的实现
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>├── services         # service的实现
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>└── BUILD.gn         # 组件的编译脚本
</span></code></pre></div>
<ol>
<li>以IOT外围设备控制组件为例</li>
</ol>
<p>IOT外围设备控制 <strong>组件</strong> 从属于IOT专用硬件服务 <strong>子系统</strong> ，IOT专用硬件服务子系统又从属于硬件服务 <strong>子系统集</strong> 。</p>
<ul>
<li>硬件服务子系统集的位置在源码的<code>base</code>目录。</li>
<li>IOT专用硬件服务子系统的位置在<code>base\iot_hardware</code>目录。</li>
<li>IOT外围设备控制组件位置就在<code>base\iot_hardware\peripheral</code>目录。</li>
</ul>
<p><img alt="image-20241229225609808" src="image-20241229225609808.png" /></p>
<p><strong>由此领域即子系统集、子系统、组件的目录结构就很明了了。</strong> 进一步剖析目录，在<code>interfaces</code>下有<code>kits</code>目录提供了应用接口，供应用开发者使用；注意<code>BUILD.gn</code>位于组件<code>peripheral</code>的根目录下，即为这个组件的编译脚本。</p>
<h4 id="3"><strong>3. 组件的定义</strong><a class="headerlink" href="#3" title="Permanent link">&para;</a></h4>
<ol>
<li>新建好一个组件后，我们需要将其定义到OpenHarmony系统中。而组件定义的位置就在<code>build\lite\components</code>目录下的<code>.json</code>文件。</li>
</ol>
<p><img alt="image-20241229225836412" src="image-20241229225836412.png" /></p>
<ol>
<li>组件必须注册到 <strong>子系统</strong> 中。然后，需要把组件的基本信息告诉子系统就完成了组件的定义。</li>
</ol>
<p>以下就是<code>iot_hardware.json</code>文件的全部定义：</p>
<div class="language-json highlight"><span class="filename">JSON</span><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="p">{</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">  </span><span class="nt">&quot;components&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">                                               </span><span class="c1">// 全部组件</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">    </span><span class="p">{</span><span class="w">                                                           </span><span class="c1">// 单个组件定义</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">      </span><span class="nt">&quot;component&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;iot_controller&quot;</span><span class="p">,</span><span class="w">                            </span><span class="c1">// 组件名称</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">      </span><span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Iot peripheral controller.&quot;</span><span class="p">,</span><span class="w">              </span><span class="c1">// 组件的功能描述</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">      </span><span class="nt">&quot;optional&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;false&quot;</span><span class="p">,</span><span class="w">                                      </span><span class="c1">// 组件是否为最小系统必选</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">      </span><span class="nt">&quot;dirs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&quot;base/iot_hardware/peripheral&quot;</span><span class="p">],</span><span class="w">                </span><span class="c1">// 组件源码目录</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">      </span><span class="nt">&quot;targets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;//base/iot_hardware/peripheral:iothardware&quot;</span><span class="p">],</span><span class="c1">// 组件编译目标</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">      </span><span class="nt">&quot;output&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">                                             </span><span class="c1">// 组件编译输出</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">      </span><span class="nt">&quot;rom&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w">                                                </span><span class="c1">// 组件的ROM容量</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="w">      </span><span class="nt">&quot;ram&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w">                                                </span><span class="c1">// 组件的RAM容量</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">      </span><span class="nt">&quot;adapted_kernel&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;liteos_m&quot;</span><span class="p">],</span><span class="w">                           </span><span class="c1">// 组件已适配的内核 </span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="w">      </span><span class="nt">&quot;features&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">                                           </span><span class="c1">// 组件可配置的特性</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="w">      </span><span class="nt">&quot;deps&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">                                                 </span><span class="c1">// 组件依赖  </span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="w">        </span><span class="nt">&quot;components&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">                                       </span><span class="c1">// 组件依赖的其他组件</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="w">        </span><span class="nt">&quot;third_party&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">                                       </span><span class="c1">// 组件依赖的第三方开源软件</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="w">  </span><span class="p">]</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="4"><strong>4. 组件的编译目标</strong><a class="headerlink" href="#4" title="Permanent link">&para;</a></h4>
<ol>
<li>编译入口其实就是组件的<code>targets</code>参数，格式约束如此<code>"targets":["路径:目标名称"]</code>。其中 <strong>路径</strong> 以绝对路径表示，<code>//</code> 开头，以源码根目录开始， <strong>目标名称</strong> 由路径下的<code>BUILD.gn</code>文件定义。</li>
<li>OpenHarmony的编译构建系统会通过这个路径找到目标的<code>BUILD.gn</code>文件，然后根据目标名称，按照这部分的要求进行编译。</li>
</ol>
<h4 id="5"><strong>5. 组件的编译脚本</strong><a class="headerlink" href="#5" title="Permanent link">&para;</a></h4>
<blockquote>
<p>以下是几种基础语法，更多可参考<a href="https://docs.openharmony.cn/pages/v4.1/zh-cn/device-dev/subsystems/subsys-build-gn-coding-style-and-best-practice.md">OpenHarmony官方关于gn介绍</a>或谷歌官网。</p>
</blockquote>
<ul>
<li>编译结果类型<ul>
<li><code>executable</code>，生成可执行文件，<code>.bin</code>文件。</li>
<li><code>shared_library</code>，生成动态链接库，<code>.so</code>文件。</li>
<li><code>static_library</code>，生成静态链接库，<code>.a</code>文件。</li>
<li><code>source_set</code>，生成中间目标，仅用于编译源文件，不生成最终的二进制文件或库。</li>
<li><code>group</code>，聚合多个目标，无直接产物。</li>
</ul>
</li>
<li>目标：编译 <strong>目标名称</strong> ，与<code>targets</code>参数的目标名称一致，官方建议与组件名称一致。</li>
<li>sources：需要编译的源文件列表，即由逗号隔开的多个<code>.c</code>文件。</li>
<li>include_dirs：头文件的路径列表，即逗号隔开的头文件所在位置，绝对路径或相对路径。</li>
</ul>
<p><code>BUILD.gn</code>模板</p>
<div class="language-text highlight"><span class="filename">Text Only</span><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>类型(&quot;目标名称&quot;){
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>    sources = [
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>        &quot;.c&quot;,
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>        &quot;.c&quot;,
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>        ......
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>    ]
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>    include_dirs = [
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>        &quot;路径&quot;,
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>        &quot;路径&quot;,
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>        ......
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>    ]
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>}
</span></code></pre></div>
<p>IOT外围设备控制组件为例，目标如下<code>"targets": ["//base/iot_hardware/peripheral:iothardware"]</code>，找到一个名为 <code>iothardware</code> 的目标组。</p>
<p><img alt="image-20241229235814264" src="image-20241229235814264.png" /></p>
<p>注意<code>$ohos_board_adapter_dir</code>代指的目录为<code>device\hisilicon\hispark_pegasus\hi3861_adapter</code>，则在<code>device\hisilicon\hispark_pegasus\hi3861_adapter\hals\iot_hardware\wifiiot_lite:hal_iothardware</code>下找到另一个<code>BUILD.gn</code>文件。编译类型为静态库，会编译<code>sources</code>下的<code>.c</code>文件，<code>include_dirs</code>为保护的头文件。</p>
<p><img alt="image-20241230000417092" src="image-20241230000417092.png" /></p>
<p>再举一个例子<code>"targets": ["//utils/native/lite/kv_store"]</code>，找到<code>BUILG.gn</code>文件。</p>
<p><img alt="image-20241230001308441" src="image-20241230001308441.png" /></p>
<p>这个脚本通过<code>lite_component</code>的<code>feature</code>方式指向<code>utils\native\lite\kv_store\src</code>目录下的<code>BUILG.gn</code>文件</p>
<p><img alt="image-20241230001509865" src="image-20241230001509865.png" /></p>
<p>再看一个，<code>`utils\native\lite</code>目录下的<code>BUILD.gn</code>文件</p>
<p><img alt="image-20241230105050811" src="image-20241230105050811.png" /></p>
<p>这个编译脚本负责整个<code>lite</code>子系统的编译，通过<code>subsystem_components</code>指向组件，其中<code>kv_store:kv_store</code>便是上一个示例所看的组件。</p>
<h3 id="313">3.1.3 子系统构建模型<a class="headerlink" href="#313" title="Permanent link">&para;</a></h3>
<p>除了<code>lite_component</code> 和 <code>lite_subsystem</code> ，从子系统定义追踪还可以找到如<code>group</code>这样的定义个人理解用法相似。然更多关于gn语法可以去<a href="https://docs.openharmony.cn/pages/v4.1/zh-cn/device-dev/subsystems/subsys-build-gn-coding-style-and-best-practice.md#编码实践">官方编译构建系统指导</a>了解学习。</p>
<p><img alt="image-20241230115633626" src="image-20241230115633626.png" /></p>
<h3 id="314">3.1.4 芯片解决方案配置规则<a class="headerlink" href="#314" title="Permanent link">&para;</a></h3>
<blockquote>
<p><a href="https://docs.openharmony.cn/pages/v4.1/zh-cn/device-dev/subsystems/subsys-build-chip_solution.md">官方芯片解决方案配置规则</a></p>
</blockquote>
<ul>
<li>芯片解决方案是指基于某款开发板的完整解决方案，包含驱动、设备侧接口适配、开发板sdk等。</li>
<li>芯片解决方案是一个特殊的部件，源码路径规则为：<strong>device/{开发板}/{芯片解决方案厂商}</strong>。</li>
<li>芯片解决方案部件会随产品选择的开发板默认编译。</li>
<li>芯片解决方案目录树规则如下：</li>
</ul>
<div class="language-shell highlight"><span class="filename">Bash</span><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="w">  </span>device<span class="w">                                      </span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">  </span>└──<span class="w"> </span>board<span class="w">                                   </span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">      </span>└──<span class="w"> </span>company<span class="w">                            </span><span class="c1"># 芯片解决方案厂商</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">           </span>└──<span class="w">  </span>hispark_aries<span class="w">                </span><span class="c1"># 开发板名称</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">                 </span>├──<span class="w"> </span>BUILD.gn<span class="w">                </span><span class="c1"># 编译脚本</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">                 </span>├──<span class="w"> </span>hals<span class="w">                    </span><span class="c1"># OS南向接口适配</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">                 </span>├──<span class="w"> </span>linux<span class="w">                   </span><span class="c1"># 可选，linux内核版本</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">                 </span>│<span class="w">   </span>└──<span class="w"> </span>config.gni<span class="w">          </span><span class="c1"># linux版本编译配置</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">                 </span>└──<span class="w"> </span>liteos_a<span class="w">                </span><span class="c1"># 可选，liteos内核版本</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="w">                     </span>└──<span class="w"> </span>config.gni<span class="w">          </span><span class="c1"># liteos_a版本编译配置</span>
</span></code></pre></div>
<blockquote>
<p><strong>注意</strong>：config.gni为开发板编译相关的配置，编译时会采用该配置文件中的参数编译所有OS部件，编译阶段系统全局可见。</p>
</blockquote>
<ul>
<li>config.gni的关键字段介绍如下：</li>
</ul>
<div class="language-shell highlight"><span class="filename">Bash</span><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="w">  </span>kernel_type:<span class="w">            </span>开发板使用的内核类型，例如：“liteos_a”,<span class="w"> </span>“liteos_m”,<span class="w"> </span>“linux”。
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">  </span>kernel_version:<span class="w">         </span>开发使用的内核版本，例如：“4.19”。
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">  </span>board_cpu:<span class="w">              </span>开发板CPU类型，例如：“cortex-a7”,<span class="w"> </span>“riscv32”。
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">  </span>board_arch:<span class="w">             </span>开发芯片arch,<span class="w"> </span>例如：<span class="w"> </span>“armv7-a”,<span class="w"> </span>“rv32imac”。
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">  </span>board_toolchain:<span class="w">        </span>开发板自定义的编译工具链名称，例如：“gcc-arm-none-eabi”。若为空，则使用默认为ohos-clang。
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">  </span>board_toolchain_prefix：编译工具链前缀，例如：“gcc-arm-none-eabi”。
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">  </span>board_toolchain_type：<span class="w">  </span>编译工具链类型，目前支持gcc和clang。例如：“gcc”<span class="w"> </span>，“clang”。
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">  </span>board_cflags：<span class="w">          </span>开发板配置的c文件编译选项。
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="w">  </span>board_cxx_flags：<span class="w">       </span>开发板配置的cpp文件编译选项。
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="w">  </span>board_ld_flags：<span class="w">        </span>开发板配置的链接选项。
</span></code></pre></div>
<h3 id="315">3.1.5 产品解决方案配置规则<a class="headerlink" href="#315" title="Permanent link">&para;</a></h3>
<blockquote>
<p><a href="https://docs.openharmony.cn/pages/v4.1/zh-cn/device-dev/subsystems/subsys-build-product.md">官方产品配置规则</a></p>
</blockquote>
<p>产品解决方案为基于开发板的完整产品，主要包含产品对OS的适配、部件拼装配置、启动配置和文件系统配置等。产品解决方案的源码路径规则为： <strong>vendor/{产品解决方案厂商}/{产品名称}</strong> 。</p>
<p>产品解决方案的目录树规则如下：</p>
<div class="language-shell highlight"><span class="filename">Bash</span><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>vendor<span class="w">                              </span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>└──<span class="w"> </span>company<span class="w">                         </span><span class="c1"># 产品解决方案厂商</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span>├──<span class="w"> </span>product<span class="w">                     </span><span class="c1"># 产品名称</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">    </span>│<span class="w">   </span>├──<span class="w"> </span>init_configs
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">    </span>│<span class="w">   </span>│<span class="w">     </span>├──<span class="w"> </span>etc<span class="w">               </span><span class="c1"># init进程启动配置（可选，仅linux内核需要）</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">    </span>│<span class="w">   </span>│<span class="w">     </span>└──<span class="w"> </span>init.cfg<span class="w">          </span><span class="c1"># 系统服务启动配置</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">    </span>│<span class="w">   </span>├──<span class="w"> </span>hals<span class="w">                    </span><span class="c1"># 产品解决方案OS适配</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">    </span>│<span class="w">   </span>├──<span class="w"> </span>BUILD.gn<span class="w">                </span><span class="c1"># 产品编译脚本</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">    </span>│<span class="w">   </span>└──<span class="w"> </span>config.json<span class="w">             </span><span class="c1"># 产品配置文件</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">    </span>│<span class="w">   </span>└──<span class="w"> </span>fs.yml<span class="w">                  </span><span class="c1"># 文件系统打包配置</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">    </span>└──<span class="w"> </span>......
</span></code></pre></div>
<p><code>vendor/company/product/config.json</code>为编译构建的主入口，包含了开发板、OS部件和内核等配置信息。</p>
<p>以基于hispark_taurus开发板的ipcamera产品为例，配置文件如下：</p>
<div class="language-shell highlight"><span class="filename">Bash</span><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="o">{</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">     </span><span class="s2">&quot;product_name&quot;</span>:<span class="w"> </span><span class="s2">&quot;ipcamera&quot;</span>,<span class="w">                       </span><span class="c1"># 产品名称</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">     </span><span class="s2">&quot;version&quot;</span>:<span class="w"> </span><span class="s2">&quot;3.0&quot;</span>,<span class="w">                                 </span><span class="c1"># config.json的版本号, 固定&quot;3.0&quot;</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">     </span><span class="s2">&quot;type&quot;</span>:<span class="w"> </span><span class="s2">&quot;small&quot;</span>,<span class="w">                                  </span><span class="c1"># 系统类型, 可选[mini, small, standard]</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">     </span><span class="s2">&quot;ohos_version&quot;</span>:<span class="w"> </span><span class="s2">&quot;OpenHarmony 1.0&quot;</span>,<span class="w">                </span><span class="c1"># 选择的OS版本</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">     </span><span class="s2">&quot;device_company&quot;</span>:<span class="w"> </span><span class="s2">&quot;hisilicon&quot;</span>,<span class="w">                    </span><span class="c1"># 芯片厂商</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">     </span><span class="s2">&quot;board&quot;</span>:<span class="w"> </span><span class="s2">&quot;hispark_taurus&quot;</span>,<span class="w">                        </span><span class="c1"># 开发板名称</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">     </span><span class="s2">&quot;kernel_type&quot;</span>:<span class="w"> </span><span class="s2">&quot;liteos_a&quot;</span>,<span class="w">                        </span><span class="c1"># 选择的内核类型</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">     </span><span class="s2">&quot;kernel_version&quot;</span>:<span class="w"> </span><span class="s2">&quot;3.0.0&quot;</span>,<span class="w">                        </span><span class="c1"># 选择的内核版本</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">     </span><span class="s2">&quot;subsystems&quot;</span>:<span class="w"> </span><span class="o">[</span><span class="w">                            </span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">       </span><span class="o">{</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">         </span><span class="s2">&quot;subsystem&quot;</span>:<span class="w"> </span><span class="s2">&quot;aafwk&quot;</span>,<span class="w">                         </span><span class="c1"># 选择的子系统</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="w">         </span><span class="s2">&quot;components&quot;</span>:<span class="w"> </span><span class="o">[</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="w">           </span><span class="o">{</span><span class="w"> </span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">             </span><span class="s2">&quot;component&quot;</span>:<span class="w"> </span><span class="s2">&quot;ability&quot;</span>,<span class="w"> </span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="w">             </span><span class="s2">&quot;features&quot;</span>:<span class="o">[</span><span class="w"> </span><span class="s2">&quot;enable_ohos_appexecfwk_feature_ability = true&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">}</span><span class="w">   </span><span class="c1"># 选择的部件和部件特性配置</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="w">         </span><span class="o">]</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="w">       </span><span class="o">}</span>,
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="w">       </span><span class="o">{</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="w">        </span>......
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="w">       </span><span class="o">}</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="w">      </span>......
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a><span class="w">      </span>更多子系统和部件
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="w">     </span><span class="o">}</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="w"> </span><span class="o">}</span>
</span></code></pre></div>
<p>我们通过<code>hb set</code>就是选择产品解决方案。</p>
<p><img alt="image-20241031160410039" src="image-20241031160410039.png" /></p>
<h2 id="32">3.2 编译构建系统的使用<a class="headerlink" href="#32" title="Permanent link">&para;</a></h2>
<h3 id="321-1">3.2.1 案例1：新增组件<a class="headerlink" href="#321-1" title="Permanent link">&para;</a></h3>
<p>在<code>applications\sample</code>目录新建<code>component_demo</code>文件夹，在该文件夹下新建<code>demo.c</code>和<code>BUILD.gn</code>文件，并编写下列源码：</p>
<p><code>demo.c</code></p>
<div class="language-C highlight"><span class="filename">C</span><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="cm">/* 新增组件示例 */</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="cp">#</span><span class="w"> </span><span class="cp">include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="c1">// OpenHarmony特有头文件</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="cp">#</span><span class="w"> </span><span class="cp">include</span><span class="w"> </span><span class="cpf">&quot;ohos_init.h&quot;</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="c1">// 定义函数</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="kt">void</span><span class="w"> </span><span class="nf">entry</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="p">{</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;This is a component.</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="p">}</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="c1">// 让entry函数在系统启动的第四阶段即system startup阶段，以优先级为 2 的级别执行</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="n">SYS_RUN</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
</span></code></pre></div>
<p><code>BUILD.gn</code></p>
<div class="language-c highlight"><span class="filename">C</span><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">static_library</span><span class="p">(</span><span class="s">&quot;TestComponent&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">    </span><span class="n">sources</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">        </span><span class="s">&quot;demo.c&quot;</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">    </span><span class="p">]</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">    </span><span class="n">include_dirs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">        </span><span class="cp"># 保护 &quot;ohos_init.h&quot; 等头文件</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">        </span><span class="s">&quot;//utils/native/lite/include&quot;</span><span class="p">,</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">    </span><span class="p">]</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="p">}</span>
</span></code></pre></div>
<p>单独编译该目标</p>
<div class="language-shell highlight"><span class="filename">Bash</span><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>hb<span class="w"> </span>build<span class="w"> </span>-f<span class="w"> </span>-T<span class="w"> </span>//applications/sample/component_demo:TestComponent
</span></code></pre></div>
<p>添加组件到子系统中，在<code>\build\lite\components\applications.json</code>文件：</p>
<p><img alt="image-20241230141729120" src="image-20241230141729120.png" /></p>
<p>可以看到这里有我们的 ”第一个程序“ 时添加的hello_world_app组件，可以在其下方继续添加我们的示例组件：</p>
<div class="language-json highlight"><span class="filename">JSON</span><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="p">{</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">      </span><span class="nt">&quot;component&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;TestComponent&quot;</span><span class="p">,</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">      </span><span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;A test component.&quot;</span><span class="p">,</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">      </span><span class="nt">&quot;optional&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;true&quot;</span><span class="p">,</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">      </span><span class="nt">&quot;dirs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w">        </span><span class="s2">&quot;applications/sample/component_demo&quot;</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">      </span><span class="p">],</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="w">      </span><span class="nt">&quot;targets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="w">        </span><span class="s2">&quot;//applications/sample/component_demo:TestComponent&quot;</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="w">      </span><span class="p">],</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="w">      </span><span class="nt">&quot;rom&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="w">      </span><span class="nt">&quot;ram&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="w">      </span><span class="nt">&quot;output&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="w">      </span><span class="nt">&quot;adapted_kernel&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&quot;liteos_m&quot;</span><span class="w"> </span><span class="p">],</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="w">      </span><span class="nt">&quot;features&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="w">      </span><span class="nt">&quot;deps&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="w">        </span><span class="nt">&quot;components&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a><span class="w">        </span><span class="nt">&quot;third_party&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="w">    </span><span class="p">},</span>
</span></code></pre></div>
<p>将组件配置到产品解决方案中，即<code>hispark_pegasus</code>，在<code>\vendor\hisilicon\hispark_pegasus\config.json</code>文件，找到<code>applications</code>子系统。</p>
<p><img alt="image-20241230142459879" src="image-20241230142459879.png" /></p>
<p>同样有我们 ”第一个程序“ 的身影，在下方添加测试组件：</p>
<div class="language-json highlight"><span class="filename">JSON</span><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="p">{</span><span class="w"> </span><span class="nt">&quot;component&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;TestComponent&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;features&quot;</span><span class="p">:[]</span><span class="w"> </span><span class="p">},</span>
</span></code></pre></div>
<p>单独编译组件</p>
<div class="language-shell highlight"><span class="filename">Bash</span><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>hb<span class="w"> </span>build<span class="w"> </span>-f<span class="w"> </span>TestComponent
</span></code></pre></div>
<p>单独编译的目标或组件不能独立运行，但容易发现错误，我们需要编译整个固件才能烧录运行。</p>
<div class="language-shell highlight"><span class="filename">Bash</span><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>hb<span class="w"> </span>build<span class="w"> </span>-f
</span></code></pre></div>
<p>烧录运行，由于我有一个之前的程序没关，所以下方还有一个<code>[love].</code>输出</p>
<p><img alt="image-20241230143145922" src="image-20241230143145922.png" /></p>
<h3 id="322-2">3.2.2 案例2：新增产品解决方案<a class="headerlink" href="#322-2" title="Permanent link">&para;</a></h3>
<blockquote>
<p><a href="https://docs.openharmony.cn/pages/v4.1/zh-cn/device-dev/subsystems/subsys-build-product.md#新增并编译产品">官方新增产品编译</a></p>
</blockquote>
<p>OpenHarmony的编译构建系统支持芯片解决方案和部件的灵活拼装，形成定制化的产品解决方案。在  <strong>vendor/{产品解决方案厂商}/{产品名称}</strong> 目录下，新建<code>vendor\cim\product1</code>目录，在<code>vendor\hisilicon\hispark_pegasus</code>基础上修改，复制<code>hispark_pegasus</code>下的<code>config.json</code>至<code>vendor\cim\product1</code>目录，按需裁剪子系统和组件，将最下方参数<code>product_adapter_dir</code>修改为 <code>//vendor/cim/product1/hals</code>。</p>
<div class="language-json highlight"><span class="filename">JSON</span><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="p">{</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">    </span><span class="nt">&quot;product_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cim_product&quot;</span><span class="p">,</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="w">    </span><span class="nt">&quot;ohos_version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;OpenHarmony 1.0&quot;</span><span class="p">,</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="w">    </span><span class="nt">&quot;device_company&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cim&quot;</span><span class="p">,</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">    </span><span class="nt">&quot;board&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;hispark_pegasus&quot;</span><span class="p">,</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w">    </span><span class="nt">&quot;kernel_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;liteos_m&quot;</span><span class="p">,</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="w">    </span><span class="nt">&quot;kernel_version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="w">    </span><span class="nt">&quot;subsystems&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="w">      </span><span class="p">{</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="w">        </span><span class="nt">&quot;subsystem&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;applications&quot;</span><span class="p">,</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="w">        </span><span class="nt">&quot;components&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="w">          </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;component&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;hello_world_app&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;features&quot;</span><span class="p">:[]</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="w">        </span><span class="p">]</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="w">      </span><span class="p">},</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="w">      </span><span class="err">...</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="w">      </span><span class="p">{</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="w">         </span><span class="err">更多子系统和部件</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="w">    </span><span class="p">],</span>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a><span class="w">    </span><span class="nt">&quot;third_party_dir&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a><span class="w">    </span><span class="nt">&quot;product_adapter_dir&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a><span class="w">  </span><span class="p">}</span>
</span></code></pre></div>
<details class="danger">
<summary>Danger</summary>
<p><strong>官方声明</strong>  ：编译构建系统编译前会对device_company，board，kernel_type，kernel_version、subsystem、component字段进行有效性检查，其中device_company，board，kernel_type，kernel_version应与已知的芯片解决方案匹配，subsystem、component应与<code>build/lite/components</code>下的部件描述匹配。</p>
</details>
<p>适配OS接口，在产品目录下创建hals目录，并将产品解决方案对OS适配的源码和编译脚本放入hals目录下。可以将复hispark_pegasus产品想应的文件夹，</p>
<p>新建<code>vendor\cim\product1\BUILD.gn</code>文件，</p>
<div class="language-text highlight"><span class="filename">Text Only</span><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>group(&quot;product1&quot;) {
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>}
</span></code></pre></div>
<p>编译产品</p>
<div class="language-text highlight"><span class="filename">Text Only</span><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>hb set
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>hb build -f 
</span></code></pre></div>
<p><img alt="image-20241230152948556" src="image-20241230152948556.png" /></p>
<p>烧录运行一切正常</p>
<p><img alt="image-20241230153820935" src="image-20241230153820935.png" /></p>
<h3 id="323-3">3.2.3 案例3：组件/模块开发<a class="headerlink" href="#323-3" title="Permanent link">&para;</a></h3>
<p>本案例目标是：实现子系统<code>applications</code>的<code>wifi_iot_sample_app</code>组件。</p>
<p><img alt="image-20241230155027849" src="image-20241230155027849.png" /></p>
<details class="danger">
<summary>Danger</summary>
<p>个人理解：判断子系统和组件不能单看文件夹层级，应首先关注<code>build\lite\components</code>目录下的<code>.json</code>文件均是子系统，故application是子系统而非领域或者说子系统集，在<code>application.json</code>中定义有<code>wifi_iot_sample_app</code>组件。</p>
</details>
<p>分析APP架构：</p>
<p><img alt="image-20241230160857556" src="image-20241230160857556.png" />zai</p>
<h4 id="1-app">1. APP架构与代码<a class="headerlink" href="#1-app" title="Permanent link">&para;</a></h4>
<p>新建<code>\applications\sample\wifi-iot\app\gn_practice</code>目录，在gn_practice文件夹下新建application、driver、library，分别存放应用程序模块、驱动模块、库模块，最终目录结构：</p>
<div class="language-shell highlight"><span class="filename">Bash</span><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>├──<span class="w"> </span>application
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>│<span class="w">   </span>├──<span class="w"> </span>app_main.c
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>│<span class="w">   </span>├──<span class="w"> </span>component_1.c
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>│<span class="w">   </span>├──<span class="w"> </span>component_1.h
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>│<span class="w">   </span>├──<span class="w"> </span>component_2.c
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>│<span class="w">   </span>└──<span class="w"> </span>component_2.h
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>├──<span class="w"> </span>driver
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>│<span class="w">   </span>├──<span class="w"> </span>drv_1.c
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>│<span class="w">   </span>└──<span class="w"> </span>drv_1.h
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>└──<span class="w"> </span>library
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="w">    </span>├──<span class="w"> </span>lib_1.c
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="w">    </span>├──<span class="w"> </span>lib_1.h
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="w">    </span>├──<span class="w"> </span>lib_2.c
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="w">    </span>└──<span class="w"> </span>lib_2.h
</span></code></pre></div>
<p><code>component_1.c</code></p>
<div class="language-C highlight"><span class="filename">C</span><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="cp">#</span><span class="w"> </span><span class="cp">include</span><span class="w"> </span><span class="cpf">&quot;component_1.h&quot;</span>
</span></code></pre></div>
<p><code>component_2.c</code></p>
<div class="language-C highlight"><span class="filename">C</span><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="cp">#</span><span class="w"> </span><span class="cp">include</span><span class="w"> </span><span class="cpf">&quot;component_2.h&quot;</span>
</span></code></pre></div>
<p><code>drv_1.c</code></p>
<div class="language-C highlight"><span class="filename">C</span><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="cp">#</span><span class="w"> </span><span class="cp">include</span><span class="w"> </span><span class="cpf">&quot;drv_1.h&quot;</span>
</span></code></pre></div>
<p><code>lib_1.c</code></p>
<div class="language-C highlight"><span class="filename">C</span><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="cp">#</span><span class="w"> </span><span class="cp">include</span><span class="w"> </span><span class="cpf">&quot;lib_1.h&quot;</span>
</span></code></pre></div>
<p><code>lib_2.c</code></p>
<div class="language-text highlight"><span class="filename">Text Only</span><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a># include &quot;lib_2.h&quot;
</span></code></pre></div>
<p><code>component_1.h</code>、<code>component_2.h</code>、<code>drv_1.h</code>、<code>lib_1.h</code>、<code>lib_2.h</code>均为空，无代码。</p>
<p>最后，<code>app_main.c</code></p>
<div class="language-C highlight"><span class="filename">C</span><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="cp">#</span><span class="w"> </span><span class="cp">include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="cp">#</span><span class="w"> </span><span class="cp">include</span><span class="w"> </span><span class="cpf">&quot;ohos_init.h&quot;</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="cp">#</span><span class="w"> </span><span class="cp">include</span><span class="w"> </span><span class="cpf">&quot;component_1.h&quot;</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="cp">#</span><span class="w"> </span><span class="cp">include</span><span class="w"> </span><span class="cpf">&quot;component_2.h&quot;</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="cp">#</span><span class="w"> </span><span class="cp">include</span><span class="w"> </span><span class="cpf">&quot;../driver/drv_1.h&quot;</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="cp">#</span><span class="w"> </span><span class="cp">include</span><span class="w"> </span><span class="cpf">&quot;../library/lib_1.h&quot;</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="cp">#</span><span class="w"> </span><span class="cp">include</span><span class="w"> </span><span class="cpf">&quot;../library/lib_2.h&quot;</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="kt">void</span><span class="w"> </span><span class="nf">myapp</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;app runs!</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="p">}</span>
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a>
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="c1">// 让myapp在系统启动的第八个阶段以优先级 2 执行</span>
</span><span id="__span-24-14"><a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="n">APP_FEATURE_INIT</span><span class="p">(</span><span class="n">myapp</span><span class="p">);</span>
</span></code></pre></div>
<p>顺便将先前的“第一个程序”执行阶段改一下，最后看一下执行效果</p>
<p><img alt="image-20241230163550544" src="image-20241230163550544.png" /></p>
<h4 id="2_1">2. 编译脚本<a class="headerlink" href="#2_1" title="Permanent link">&para;</a></h4>
<p>新建<code>\applications\sample\wifi-iot\app\gn_practice\application\BUILD.gn</code>编译脚本，源码如下：</p>
<div class="language-text highlight"><span class="filename">Text Only</span><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>static_library(&quot;gn_app&quot;) {
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>    sources = [
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>        &quot;app_main.c&quot;,
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>        &quot;component_1.c&quot;,
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>        &quot;component_2.c&quot;,
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>    ]
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>    include_dirs = [
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>        &quot;../driver&quot;,
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>        &quot;../library&quot;,
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a>        &quot;//utils/native/lite/include&quot;,
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a>    ]
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>    cflags = [ &quot;-Wno-unused-variable&quot; ]
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a>    cflags += [ &quot;-Wno-unused-but-set-variable&quot; ]
</span><span id="__span-25-14"><a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a>    cflags += [ &quot;-Wno-unused-parameter&quot; ]
</span><span id="__span-25-15"><a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a>}
</span></code></pre></div>
<p>看完编译构建系统部分后，sources和include_dirs部分应该不难理解，而后面三行是编译参数，意思分别为 “未使用的变量” 、 “以初始化未使用的变量” 、 “未使用的参数” ，这三种情况默认编译方式并不允许。</p>
<p>新建<code>\applications\sample\wifi-iot\app\gn_practice\driver\BUILD.gn</code>编译脚本，源码如下：</p>
<div class="language-text highlight"><span class="filename">Text Only</span><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>static_library(&quot;gn_driver&quot;) {
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>    sources = [
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>        &quot;drv_1.c&quot;,
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>    ]
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>    include_dirs = [
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>        &quot;//utils/native/lite/include&quot;,
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>    ]
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>}
</span></code></pre></div>
<p>新建<code>\applications\sample\wifi-iot\app\gn_practice\library\BUILD.gn</code>编译脚本，源码如下：</p>
<div class="language-text highlight"><span class="filename">Text Only</span><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>static_library(&quot;gn_library&quot;) {
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>    sources = [
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>        &quot;lib_1.c&quot;,
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>        &quot;lib_2.c&quot;
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a>    ]
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>    include_dirs = [
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>        &quot;//utils/native/lite/include&quot;,
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>    ]
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a>}
</span></code></pre></div>
<p>以上编写的模块是基于<code>wifi_iot_sample_app</code>组件，在<code>\build\lite\components\applications.json</code>文件中找到组件。</p>
<p><img alt="image-20241230155027849" src="image-20241230155027849.png" /></p>
<p>通过参数<code>targets</code>可以看到编译目标是<code>/applications/sample/wifi-iot/app"</code>目录下的<code>BUILD.gn</code>文件，它的默认代码为：</p>
<div class="language-text highlight"><span class="filename">Text Only</span><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>import(&quot;//build/lite/config/component/lite_component.gni&quot;)
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>lite_component(&quot;app&quot;) {
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>    features = [
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>        &quot;startup&quot;,
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>    ]
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>}
</span></code></pre></div>
<p>将其修改为如下内容，这样OpenHarmony的编译构建系统就会找到各个模块下的<code>BUILD.gn</code>文件，然后根据<code>BUILD.gn</code>文件目标编译。</p>
<div class="language-text highlight"><span class="filename">Text Only</span><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>import(&quot;//build/lite/config/component/lite_component.gni&quot;)
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>lite_component(&quot;app&quot;) {
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>    features = [
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>        &quot;gn_practice/application:gn_app&quot;,
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>        &quot;gn_practice/driver:gn_driver&quot;,
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a>        &quot;gn_practice/library:gn_library&quot;,
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>    ]
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a>}
</span></code></pre></div>
<h4 id="3_1">3. 编译烧录运行<a class="headerlink" href="#3_1" title="Permanent link">&para;</a></h4>
<p>编译产品</p>
<div class="language-shell highlight"><span class="filename">Bash</span><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>hb<span class="w"> </span><span class="nb">set</span>
</span></code></pre></div>
<div class="language-shell highlight"><span class="filename">Bash</span><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>hb<span class="w"> </span>build<span class="w"> </span>-f
</span></code></pre></div>
<p>烧录运行，可以看到，打印信息按照系统启动阶段正确划分。</p>
<p><img alt="image-20241230170116037" src="image-20241230170116037.png" /></p>
<h3 id="324">3.2.4 系统启动阶段与宏命令<a class="headerlink" href="#324" title="Permanent link">&para;</a></h3>
<p><img alt="image-20241230170407409" src="image-20241230170407409.png" /></p>
<h2 id="33">3.3 轻量系统的数据持久化<a class="headerlink" href="#33" title="Permanent link">&para;</a></h2>
<h3 id="331">3.3.1 数据持久化简介<a class="headerlink" href="#331" title="Permanent link">&para;</a></h3>
<p><strong>数据持久化</strong> 是指将 <strong>内存中的数据模型</strong> 转换为 <strong>存储模型</strong> ，以及将 <strong>存储模型</strong> 转换回 <strong>内存数据模型</strong> 的过程。其主要目的是让数据在程序关闭或系统重启后依然可以保存和恢复。</p>
<p><strong>数据模型</strong> ：通常是程序运行时使用的对象模型或数据结构（如类、对象、字典、数组）。</p>
<p><strong>存储模型</strong> ：指数据在持久化介质上的表现形式，可以是：</p>
<ul>
<li><strong>关系模型</strong>（如数据库中的表）</li>
<li><strong>XML</strong>、<strong>JSON</strong> 等格式化数据</li>
<li><strong>键值对</strong>（如 Redis、分布式 KV 存储）</li>
<li><strong>图形模型</strong>（如图数据库）</li>
<li><strong>二进制流</strong> 或 <strong>自定义格式</strong></li>
</ul>
<p><strong>基本操作（CRUD）</strong>  数据持久化的核心操作包括：</p>
<ul>
<li><strong>Create</strong> （创建）：将数据存储到持久化介质。</li>
<li><strong>Read</strong> （读取）：从持久化介质加载数据。</li>
<li><strong>Update</strong> （更新）：修改存储中的数据。</li>
<li><strong>Delete</strong> （删除）：移除存储中的数据。</li>
</ul>
<p>⚛️： <strong>OpenHarmony</strong> 的轻量系统提供了两种数据持久化的方法，即 <strong>键值存储</strong> 和 <strong>文件操作</strong> 。</p>
<h3 id="332">3.3.2 键值存储与文件操作简介<a class="headerlink" href="#332" title="Permanent link">&para;</a></h3>
<p><strong>键值存储</strong> ，键即 key ，值即 value ，所以又称 KV存储 。其中，key最大为 32 字节（包含字符串停止符），value最大为 128 字节（包含字符串停止符）。</p>
<details class="danger">
<summary>Danger</summary>
<p>在 <strong>OpenHarmony</strong> 中，key是文件名，将value保存到对应的文件中。</p>
</details>
<p><strong>文件操作</strong> ，文件内容可以是XML、JSON、键值、自定义数据结构等。</p>
<p>键值存储和文件操作组件位于公共基础库子系统，如图所示：</p>
<p><img alt="image-20241230195001016" src="image-20241230195001016.png" /></p>
<h3 id="333">3.3.3 键值存储案例<a class="headerlink" href="#333" title="Permanent link">&para;</a></h3>
<p>键值存储相关API：</p>
<table>
<thead>
<tr>
<th>API名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>UtilsGetValue</code></td>
<td>从文件系统或缓存中读取与key想匹配的value</td>
</tr>
<tr>
<td><code>UtilsSetValue</code></td>
<td>从文件系统或缓存中更新或添加与key匹配的value</td>
</tr>
<tr>
<td><code>UtilsDeleteValue</code></td>
<td>从文件系统或缓存中删除与可以匹配的value</td>
</tr>
</tbody>
</table>
<details class="danger">
<summary>注意</summary>
<p>这一段书中明确指出希望大家学会阅读源码和查看API，其实简单来说就是会查看函数的定义和声明位置，阅读函数注释，获得函数的参数、返回值、基本功能等信息。</p>
</details>
<p>我结合STM32HAL库的代码和OpenHarmony源码谈一谈自己的经验：</p>
<p>首先，有一点代码规范不同，STM32的函数注释写在 <strong>函数的定义处</strong> ，而OpenHarmony的函数注释写在 <strong>函数声明处</strong> 。</p>
<p><img alt="image-20241230201654849" src="image-20241230201654849.png" /></p>
<p>在Vscode中函数位置右键，转到声明：</p>
<p><img alt="image-20241230201748457" src="image-20241230201748457.png" /></p>
<p>OpenHarmony源码注释与STM32类似，所以不在解释，自行阅读源码理解各参数。</p>
<p><img alt="image-20241230201840703" src="image-20241230201840703.png" /></p>
<blockquote>
<p>API表格便是根据源码注释汇总，而非照搬书中，我们应更好的理解英文原意，特别是像key、value这种专业术语翻译是无法正确翻译出来的，这时最后就是不翻译，所以基础的英语功底是必须的。</p>
</blockquote>
<hr />
<p>由于value和key涉及到字节数，这里补充一点C语言基础：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>字节数（32 位系统）</th>
<th>字节数（64 位系统）</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>char</code></td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td><code>int</code></td>
<td>4</td>
<td>4</td>
</tr>
<tr>
<td><code>float</code></td>
<td>4</td>
<td>4</td>
</tr>
<tr>
<td><code>double</code></td>
<td>8</td>
<td>8</td>
</tr>
<tr>
<td><code>long</code></td>
<td>4</td>
<td>8</td>
</tr>
<tr>
<td><code>long long</code></td>
<td>8</td>
<td>8</td>
</tr>
<tr>
<td>指针类型</td>
<td>4</td>
<td>8</td>
</tr>
</tbody>
</table>
<p><strong>注意</strong>：实际大小可能因编译器实现或系统架构而异，单片机多为32位，可用 <code>sizeof()</code> 函数检查。</p>
<p>案例目标：若键值不存在就写入一个键值对，若存在则打印这个键值对。</p>
<p><code>\applications\sample\wifi-iot\app</code>目录下新建kv_store_demo文件夹，并在该文件夹下新建<code>demo.c</code>和<code>BUILD.gn</code>文件，源码如下：</p>
<p><code>demo.c</code></p>
<div class="language-C highlight"><span class="filename">C</span><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="cp">#</span><span class="w"> </span><span class="cp">include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="cp">#</span><span class="w"> </span><span class="cp">include</span><span class="w"> </span><span class="cpf">&quot;ohos_init.h&quot;</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="cp">#</span><span class="w"> </span><span class="cp">include</span><span class="w"> </span><span class="cpf">&quot;kv_store.h&quot;</span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="n">C</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;name&quot;</span><span class="p">;</span>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">value</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a>
</span><span id="__span-32-8"><a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a>
</span><span id="__span-32-9"><a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a><span class="kt">void</span><span class="w"> </span><span class="nf">kv_storeTest</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-32-10"><a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a><span class="p">{</span>
</span><span id="__span-32-11"><a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">retGet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UtilsGetValue</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">);</span>
</span><span id="__span-32-12"><a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">retGet</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-32-13"><a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-32-14"><a id="__codelineno-32-14" name="__codelineno-32-14" href="#__codelineno-32-14"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">valueToWrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;OpenHarmony.&quot;</span><span class="p">;</span>
</span><span id="__span-32-15"><a id="__codelineno-32-15" name="__codelineno-32-15" href="#__codelineno-32-15"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">retSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UtilsSetValue</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">valueToWrite</span><span class="p">);</span>
</span><span id="__span-32-16"><a id="__codelineno-32-16" name="__codelineno-32-16" href="#__codelineno-32-16"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;SetValue --&gt; result: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">retSet</span><span class="p">);</span>
</span><span id="__span-32-17"><a id="__codelineno-32-17" name="__codelineno-32-17" href="#__codelineno-32-17"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-32-18"><a id="__codelineno-32-18" name="__codelineno-32-18" href="#__codelineno-32-18"></a><span class="w">    </span><span class="k">else</span>
</span><span id="__span-32-19"><a id="__codelineno-32-19" name="__codelineno-32-19" href="#__codelineno-32-19"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-32-20"><a id="__codelineno-32-20" name="__codelineno-32-20" href="#__codelineno-32-20"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;GetValue --&gt; result: %d value: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">retGet</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
</span><span id="__span-32-21"><a id="__codelineno-32-21" name="__codelineno-32-21" href="#__codelineno-32-21"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-32-22"><a id="__codelineno-32-22" name="__codelineno-32-22" href="#__codelineno-32-22"></a>
</span><span id="__span-32-23"><a id="__codelineno-32-23" name="__codelineno-32-23" href="#__codelineno-32-23"></a><span class="p">}</span>
</span><span id="__span-32-24"><a id="__codelineno-32-24" name="__codelineno-32-24" href="#__codelineno-32-24"></a>
</span><span id="__span-32-25"><a id="__codelineno-32-25" name="__codelineno-32-25" href="#__codelineno-32-25"></a>
</span><span id="__span-32-26"><a id="__codelineno-32-26" name="__codelineno-32-26" href="#__codelineno-32-26"></a><span class="n">APP_FEATURE_INIT</span><span class="p">(</span><span class="n">kv_storeTest</span><span class="p">);</span>
</span></code></pre></div>
<p><code>BUILD.gn</code></p>
<div class="language-C highlight"><span class="filename">C</span><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="n">static_library</span><span class="p">(</span><span class="s">&quot;kv_store_demo&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="w">    </span><span class="n">sources</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="w">        </span><span class="s">&quot;demo.c&quot;</span><span class="p">,</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="w">    </span><span class="p">]</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="w">    </span><span class="n">include_dirs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="w">        </span><span class="s">&quot;//utils/native/lite/include&quot;</span><span class="p">,</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="w">    </span><span class="p">]</span>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="p">}</span>
</span></code></pre></div>
<p>修改<code>\applications\sample\wifi-iot\app</code>目录下的<code>BUILD.gn</code>文件：</p>
<div class="language-shell highlight"><span class="filename">Bash</span><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>import<span class="o">(</span><span class="s2">&quot;//build/lite/config/component/lite_component.gni&quot;</span><span class="o">)</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>lite_component<span class="o">(</span><span class="s2">&quot;app&quot;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="w">    </span><span class="nv">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="w">        </span><span class="s2">&quot;gn_practice/application:gn_app&quot;</span>,
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="w">        </span><span class="s2">&quot;gn_practice/driver:gn_driver&quot;</span>,
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="w">        </span><span class="s2">&quot;gn_practice/library:gn_library&quot;</span>,
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a><span class="w">        </span><span class="s2">&quot;kv_store_demo:kv_store_demo&quot;</span>,<span class="w">   </span><span class="c1"># 新增内容</span>
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a><span class="w">    </span><span class="o">]</span>
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a><span class="o">}</span>
</span></code></pre></div>
<p>编译烧录，重启开发板，键中无数据，再次重启 “openhamony.”被写入，且断电不丢失。</p>
<p><img alt="image-20241230210027048" src="image-20241230210027048.png" /></p>
<details class="danger">
<summary>几点说明</summary>
<p>关于数据定义为什么是<code>const char*</code>不是<code>char</code>，为什么是<code>int</code>而不是<code>uint16</code>等，均是根据源码定义的形参决定。</p>
</details>
<h3 id="334">3.3.4 文件操作案例<a class="headerlink" href="#334" title="Permanent link">&para;</a></h3>
<p>如果上一节注意到<code>kv_store.h</code>头文件的位置，就会发现这节需要用到的<code>utils_file.h</code>头文件和它在一个位置，故自行阅读源码理解函数作用。</p>
<p>案例目标：若文件不存在，就创建文件、写入内容（ssid和passwd），若文件存在则读取内容并删除文件。</p>
<p><code>\applications\sample\wifi-iot\app</code>目录下新建file_demo文件夹，并在该文件夹下新建<code>demo.c</code>和<code>BUILD.gn</code>文件，源码如下：</p>
<p><code>demo.c</code></p>
<div class="language-C highlight"><span class="filename">C</span><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span><span class="c1">     </span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ohos_init.h&quot;</span><span class="c1"> </span>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;utils_file.h&quot;</span><span class="c1"> </span>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="kt">void</span><span class="w"> </span><span class="nf">file_demo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="p">{</span>
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">filename</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;wifi_INFO&quot;</span><span class="p">;</span>
</span><span id="__span-35-10"><a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">fileslen</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-35-11"><a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UtilsFileStat</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fileslen</span><span class="p">);</span>
</span><span id="__span-35-12"><a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span>
</span><span id="__span-35-13"><a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-35-14"><a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a><span class="w">        </span><span class="c1">// 创建写入的数据</span>
</span><span id="__span-35-15"><a id="__codelineno-35-15" name="__codelineno-35-15" href="#__codelineno-35-15"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">dataWrite</span><span class="o">=</span><span class="w"> </span><span class="s">&quot;openharmony,123456789&quot;</span><span class="p">;</span>
</span><span id="__span-35-16"><a id="__codelineno-35-16" name="__codelineno-35-16" href="#__codelineno-35-16"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s文件不存在。</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">);</span>
</span><span id="__span-35-17"><a id="__codelineno-35-17" name="__codelineno-35-17" href="#__codelineno-35-17"></a><span class="w">        </span><span class="c1">// 打开文件</span>
</span><span id="__span-35-18"><a id="__codelineno-35-18" name="__codelineno-35-18" href="#__codelineno-35-18"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UtilsFileOpen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">O_WRONLY_FS</span><span class="o">|</span><span class="n">O_CREAT_FS</span><span class="o">|</span><span class="n">O_TRUNC_FS</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-35-19"><a id="__codelineno-35-19" name="__codelineno-35-19" href="#__codelineno-35-19"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;OpenFile --&gt; result: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">);</span>
</span><span id="__span-35-20"><a id="__codelineno-35-20" name="__codelineno-35-20" href="#__codelineno-35-20"></a><span class="w">        </span><span class="c1">// 写入数据</span>
</span><span id="__span-35-21"><a id="__codelineno-35-21" name="__codelineno-35-21" href="#__codelineno-35-21"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">data_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UtilsFileWrite</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">dataWrite</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">dataWrite</span><span class="p">));</span>
</span><span id="__span-35-22"><a id="__codelineno-35-22" name="__codelineno-35-22" href="#__codelineno-35-22"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;WriteFile --&gt; result: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">data_len</span><span class="p">);</span>
</span><span id="__span-35-23"><a id="__codelineno-35-23" name="__codelineno-35-23" href="#__codelineno-35-23"></a><span class="w">        </span><span class="c1">// 关闭文件</span>
</span><span id="__span-35-24"><a id="__codelineno-35-24" name="__codelineno-35-24" href="#__codelineno-35-24"></a><span class="w">        </span><span class="n">UtilsFileClose</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span id="__span-35-25"><a id="__codelineno-35-25" name="__codelineno-35-25" href="#__codelineno-35-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-35-26"><a id="__codelineno-35-26" name="__codelineno-35-26" href="#__codelineno-35-26"></a><span class="w">    </span><span class="k">else</span>
</span><span id="__span-35-27"><a id="__codelineno-35-27" name="__codelineno-35-27" href="#__codelineno-35-27"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-35-28"><a id="__codelineno-35-28" name="__codelineno-35-28" href="#__codelineno-35-28"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s文件存在。</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">);</span>
</span><span id="__span-35-29"><a id="__codelineno-35-29" name="__codelineno-35-29" href="#__codelineno-35-29"></a><span class="w">         </span><span class="c1">// 打开文件，读写模式</span>
</span><span id="__span-35-30"><a id="__codelineno-35-30" name="__codelineno-35-30" href="#__codelineno-35-30"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UtilsFileOpen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDWR_FS</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-35-31"><a id="__codelineno-35-31" name="__codelineno-35-31" href="#__codelineno-35-31"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;OpenFile --&gt; result: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">);</span>
</span><span id="__span-35-32"><a id="__codelineno-35-32" name="__codelineno-35-32" href="#__codelineno-35-32"></a><span class="w">        </span><span class="c1">// 定位读写偏移量</span>
</span><span id="__span-35-33"><a id="__codelineno-35-33" name="__codelineno-35-33" href="#__codelineno-35-33"></a><span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UtilsFileSeek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">SEEK_SET_FS</span><span class="p">);</span>
</span><span id="__span-35-34"><a id="__codelineno-35-34" name="__codelineno-35-34" href="#__codelineno-35-34"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;SeekFile --&gt; result: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
</span><span id="__span-35-35"><a id="__codelineno-35-35" name="__codelineno-35-35" href="#__codelineno-35-35"></a><span class="w">        </span><span class="c1">// 读取数据</span>
</span><span id="__span-35-36"><a id="__codelineno-35-36" name="__codelineno-35-36" href="#__codelineno-35-36"></a><span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="n">ssid</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
</span><span id="__span-35-37"><a id="__codelineno-35-37" name="__codelineno-35-37" href="#__codelineno-35-37"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">data_len1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UtilsFileRead</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">ssid</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">);</span>
</span><span id="__span-35-38"><a id="__codelineno-35-38" name="__codelineno-35-38" href="#__codelineno-35-38"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;ReadFile --&gt; result: %d ssid: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">data_len1</span><span class="p">,</span><span class="w"> </span><span class="n">ssid</span><span class="p">);</span>
</span><span id="__span-35-39"><a id="__codelineno-35-39" name="__codelineno-35-39" href="#__codelineno-35-39"></a><span class="w">        </span><span class="c1">// 重新定位读写偏移量</span>
</span><span id="__span-35-40"><a id="__codelineno-35-40" name="__codelineno-35-40" href="#__codelineno-35-40"></a><span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UtilsFileSeek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">SEEK_CUR_FS</span><span class="p">);</span>
</span><span id="__span-35-41"><a id="__codelineno-35-41" name="__codelineno-35-41" href="#__codelineno-35-41"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;SeekFile --&gt; result: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
</span><span id="__span-35-42"><a id="__codelineno-35-42" name="__codelineno-35-42" href="#__codelineno-35-42"></a><span class="w">        </span><span class="c1">// 读取数据</span>
</span><span id="__span-35-43"><a id="__codelineno-35-43" name="__codelineno-35-43" href="#__codelineno-35-43"></a><span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="n">passwd</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
</span><span id="__span-35-44"><a id="__codelineno-35-44" name="__codelineno-35-44" href="#__codelineno-35-44"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">data_len2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UtilsFileRead</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">passwd</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">);</span>
</span><span id="__span-35-45"><a id="__codelineno-35-45" name="__codelineno-35-45" href="#__codelineno-35-45"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;ReadFile --&gt; result: %d passwd: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">data_len2</span><span class="p">,</span><span class="w"> </span><span class="n">passwd</span><span class="p">);</span>
</span><span id="__span-35-46"><a id="__codelineno-35-46" name="__codelineno-35-46" href="#__codelineno-35-46"></a><span class="w">        </span><span class="c1">// 关闭文件</span>
</span><span id="__span-35-47"><a id="__codelineno-35-47" name="__codelineno-35-47" href="#__codelineno-35-47"></a><span class="w">        </span><span class="n">UtilsFileClose</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span id="__span-35-48"><a id="__codelineno-35-48" name="__codelineno-35-48" href="#__codelineno-35-48"></a>
</span><span id="__span-35-49"><a id="__codelineno-35-49" name="__codelineno-35-49" href="#__codelineno-35-49"></a><span class="w">        </span><span class="c1">// 删除文件</span>
</span><span id="__span-35-50"><a id="__codelineno-35-50" name="__codelineno-35-50" href="#__codelineno-35-50"></a><span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UtilsFileDelete</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
</span><span id="__span-35-51"><a id="__codelineno-35-51" name="__codelineno-35-51" href="#__codelineno-35-51"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;DeleteFile --&gt; result: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
</span><span id="__span-35-52"><a id="__codelineno-35-52" name="__codelineno-35-52" href="#__codelineno-35-52"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-35-53"><a id="__codelineno-35-53" name="__codelineno-35-53" href="#__codelineno-35-53"></a>
</span><span id="__span-35-54"><a id="__codelineno-35-54" name="__codelineno-35-54" href="#__codelineno-35-54"></a>
</span><span id="__span-35-55"><a id="__codelineno-35-55" name="__codelineno-35-55" href="#__codelineno-35-55"></a><span class="p">}</span>
</span><span id="__span-35-56"><a id="__codelineno-35-56" name="__codelineno-35-56" href="#__codelineno-35-56"></a>
</span><span id="__span-35-57"><a id="__codelineno-35-57" name="__codelineno-35-57" href="#__codelineno-35-57"></a>
</span><span id="__span-35-58"><a id="__codelineno-35-58" name="__codelineno-35-58" href="#__codelineno-35-58"></a><span class="n">APP_FEATURE_INIT</span><span class="p">(</span><span class="n">file_demo</span><span class="p">);</span>
</span></code></pre></div>
<p><code>BUILD.gn</code></p>
<div class="language-shell highlight"><span class="filename">Bash</span><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>static_library<span class="o">(</span><span class="s2">&quot;file_demo&quot;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="w">    </span><span class="nv">sources</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="w">        </span><span class="s2">&quot;demo.c&quot;</span>,
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="w">    </span><span class="o">]</span>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="w">    </span><span class="nv">include_dirs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="w">        </span><span class="s2">&quot;//utils/native/lite/include&quot;</span>,
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a><span class="w">    </span><span class="o">]</span>
</span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a><span class="o">}</span>
</span></code></pre></div>
<p>修改<code>\applications\sample\wifi-iot\app</code>目录下的<code>BUILD.gn</code>文件：</p>
<div class="language-shell highlight"><span class="filename">Bash</span><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>import<span class="o">(</span><span class="s2">&quot;//build/lite/config/component/lite_component.gni&quot;</span><span class="o">)</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>lite_component<span class="o">(</span><span class="s2">&quot;app&quot;</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="w">    </span><span class="nv">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="w">        </span><span class="s2">&quot;gn_practice/application:gn_app&quot;</span>,
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="w">        </span><span class="s2">&quot;gn_practice/driver:gn_driver&quot;</span>,
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="w">        </span><span class="s2">&quot;gn_practice/library:gn_library&quot;</span>,
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="w">        </span><span class="s2">&quot;kv_store_demo:kv_store_demo&quot;</span>,
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="w">        </span><span class="s2">&quot;file_demo:file_demo&quot;</span>,
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a><span class="w">    </span><span class="o">]</span>
</span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a><span class="o">}</span>
</span></code></pre></div>
<p>编译烧录运行，复位，文件为空，写入文件。</p>
<p><img alt="image-20241230222237353" src="image-20241230222237353.png" /></p>
<p>再次复位，读取文件内容。</p>
<p><img alt="image-20241230222333920" src="image-20241230222333920.png" /></p>







  
  




  <!-- <h2 id="__comments"> </h2> -->
  <!-- Insert generated snippet here -->
  <script src="https://giscus.app/client.js"
        data-repo="wxnlP/wxnlP.github.io"
        data-repo-id="R_kgDOMKIl5g"
        data-category="Announcements"
        data-category-id="DIC_kwDOMKIl5s4Cl1nL"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="zh-CN"
        crossorigin="anonymous"
        async>
</script>
  <!-- Synchronize Giscus theme with palette -->
  <script>
    var giscus = document.querySelector("script[src*=giscus]")

    // Set palette on initial load
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
      var theme = palette.color.scheme === "slate"
        ? "transparent_dark"
        : "light"

      // Instruct Giscus to set theme
      giscus.setAttribute("data-theme", theme) 
    }

    // Register event handlers after documented loaded
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate"
            ? "transparent_dark"
            : "light"

          // Instruct Giscus to change theme
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
    
  </script>

                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../2.OHIDE%E5%BC%80%E5%8F%91/" class="md-footer__link md-footer__link--prev" aria-label="Previous: 第二章 IDE开发">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                第二章 IDE开发
              </div>
            </div>
          </a>
        
        
          
          <a href="../../ROS2/1.1-ROS%E4%B8%8EROS2%E4%BB%8B%E7%BB%8D/" class="md-footer__link md-footer__link--next" aria-label="Next: 第一章 ROS与ROS2介绍">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                第一章 ROS与ROS2介绍
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["content.action.edit", "navigation.tabs", "navigation.instant", "content.action.view", "content.code.annotate", "content.code.copy", "content.footnote.tooltips", "content.tooltips", "sticky_navigation", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.prune", "navigation.sections", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../assets/javascripts/workers/search.07f07601.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.56dfad97.min.js"></script>
      
        <script src="../../../js/math.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>